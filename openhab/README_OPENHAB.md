# OpenHAB Configuration for Enphase Envoy

This directory contains OpenHAB configuration files to integrate your Enphase Envoy MQTT data stream.

## Files

- **solar.things** - MQTT Thing definition with channels for all Envoy data points
- **solar.items** - Item definitions for power readings, calculations, and counters
- **solar.rules** - Automation rules for calculations, alerts, and smart automations
- **solar.sitemap** - UI sitemap for displaying solar system data

## Installation

1. **Install MQTT Binding** (if not already installed):
   - Go to Settings → Bindings → Install "MQTT Binding"

2. **Install JSONPath Transformation** (required for parsing JSON):
   - Go to Settings → Bindings → Install "JSONPath Transformation"

3. **Copy files to OpenHAB configuration directory**:
   ```bash
   # Typical OpenHAB config locations:
   # Linux: /etc/openhab/
   # macOS: /usr/local/etc/openhab/
   # Docker: /openhab/conf/
   
   cp solar.things <openhab-config>/things/
   cp solar.items <openhab-config>/items/
   cp solar.rules <openhab-config>/rules/
   cp solar.sitemap <openhab-config>/sitemaps/
   ```

4. **Adjust MQTT broker settings** in `solar.things`:
   - Update host, port, username, password if different from defaults
   - Change `clientID` if you have multiple OpenHAB instances

5. **Restart OpenHAB** or wait for automatic configuration reload

## Configuration

### Electricity Rate
Edit the `ELECTRICITY_RATE` variable in `solar.rules` to match your electricity cost per kWh for accurate savings calculations.

### MQTT Topic
If you change your MQTT topic from `/envoy/json`, update all `stateTopic` entries in `solar.things`.

## Features

### Real-time Monitoring
- **Solar Production** - Current watts being generated by panels
- **House Consumption** - Current power usage
- **Grid Power** - Import (positive) or Export (negative)
- **Self Consumption** - How much solar is directly used vs exported

### Daily Totals
- Production, consumption, import, and export energy (kWh)
- Cost savings based on electricity rate
- Peak power values

### Status & Health
- Connection status monitoring
- Data age tracking with alerts for stale data
- Last update timestamp

### Smart Automations (Examples in rules)
- **Excess Solar Detection** - Trigger when exporting >2kW
- **Low Production Alert** - Warn if production drops during daylight
- **High Consumption Alert** - Log when usage exceeds 8kW
- **Daily Reset** - Clear counters at midnight

## Customization

### Add Custom Automation
Edit `solar.rules` to add your own automation. Examples:

```java
rule "Start pool pump with excess solar"
when
    Item Solar_GridExport changed
then
    if (Solar_GridExport.state instanceof Number) {
        val export = (Solar_GridExport.state as Number).floatValue
        if (export > 1500) { // Exporting >1.5kW
            sendCommand(PoolPump_Switch, ON)
        }
    }
end
```

### Add Notifications
Install the Cloud Connector or other notification binding and add to rules:

```java
sendNotification("you@example.com", "High solar export - run appliances now!")
```

### Persistence
To store historical data for charts, configure persistence in OpenHAB:

1. Install InfluxDB or RRD4j persistence binding
2. Configure items to persist (e.g., gSolarPower, gSolarEnergy groups)

## UI Access

- **Main UI**: Browse to Settings → Things → MQTT → Enphase Envoy
- **Sitemap**: Access via BasicUI or mobile app: `http://your-openhab:8080/basicui/app?sitemap=solar`

## Troubleshooting

### No data appearing
1. Check MQTT broker connection: Settings → Things → MQTT Bridge
2. Verify JSONPath transformation is installed
3. Check logs: `/var/log/openhab/openhab.log` or Events log in UI
4. Verify Envoy script is running and publishing to MQTT

### Values show "NULL" or "UNDEF"
- Wait a few seconds for first MQTT message to arrive
- Check the MQTT topic name matches in both the Python script and Things file

### Rules not firing
- Check rule syntax in logs
- Verify items are receiving updates (watch Events log)
- Ensure item names in rules match item names in items file

## Data Flow

```
Enphase Envoy → Python Script → MQTT Broker → OpenHAB MQTT Binding → Things → Items → Rules → UI
```

## Tips

1. **Performance**: The script publishes updates ~1-2 times per second. This is high frequency but manageable for OpenHAB.

2. **Energy Calculations**: The daily energy totals use accumulation based on power readings. For more accuracy, consider using OpenHAB's persistence with integrating counters.

3. **Groups**: Items are organized in groups (`gSolar`, `gSolarPower`, `gSolarEnergy`) for easy charting and bulk operations.

4. **Charting**: The sitemap includes chart examples. Install a persistence service for long-term storage and better charts.

5. **Mobile App**: Use the OpenHAB mobile app to view the sitemap on your phone.
